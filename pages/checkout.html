<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Оформление заказа</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent: #ff7847;
      --accent-hover: #e85a2b;
      --bg: #f9f9f9;
      --fg: #333;
      --muted: #666;
      --border: #ddd;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--fg); }
    header { padding: 20px; text-align: center; }
    h1 { color: var(--accent); margin: 10px 0 0; }
    .page { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .grid { display: grid; grid-template-columns: 1fr 380px; gap: 20px; }
    .card { background: #fff; border-radius: 10px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
    .section-title { margin: 0 0 10px; font-size: 18px; font-weight: 700; }

    /* Cart list */
    .item { display: grid; grid-template-columns: 80px 1fr auto; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .item:last-child { border-bottom: none; }
    .thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; }
    .name { margin: 0 0 4px; font-weight: 600; }
    .muted { color: var(--muted); font-size: 13px; }
    .qty { display: inline-flex; align-items: center; gap: 8px; margin-top: 6px; }
    .qty-btn { width: 28px; height: 28px; background: var(--accent); border: none; color: #fff; border-radius: 4px; cursor: pointer; font-weight: 600; }
    .qty-btn:hover { background: var(--accent-hover); }
    .line-total { min-width: 90px; text-align: right; font-weight: 600; }

    /* Address + shipping */
    .field { margin: 10px 0; }
    .label { display: block; font-size: 13px; color: var(--muted); margin-bottom: 6px; }
    .input, .select, textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 4px; }

    .options { margin-top: 10px; }
    .option { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin: 8px 0; }
    .option input { margin: 0; }
    .option .price { margin-left: auto; font-weight: 700; }
    .loading, .error { padding: 10px; border-radius: 6px; font-size: 14px; }
    .loading { background: #fff7f3; color: #b24d2f; border: 1px dashed #f3b197; }
    .error { background: #fff3f3; color: #9c2f2f; border: 1px solid #ffb5b5; }
    .warn { background: #fffdf3; color: #8a6d1a; border: 1px solid #f6e7a1; }

    /* Summary */
    .summary-row { display: flex; justify-content: space-between; margin: 6px 0; }
    .summary-row.total { font-size: 18px; font-weight: 800; }

    .actions { display: flex; gap: 10px; margin-top: 14px; }
    .btn { padding: 12px 16px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
    .btn-secondary { background: #e7e7e7; color: #222; }
    .btn-secondary:hover { background: #d8d8d8; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    @media (max-width: 900px){ .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Оформление заказа</h1>
  </header>

  <div class="page">
    <div class="grid">
      <!-- Left: Items -->
      <div class="card">
        <h2 class="section-title">Товары</h2>
        <div id="items"></div>
      </div>

      <!-- Right: Address and Shipping -->
      <div class="card">
        <h2 class="section-title">Доставка</h2>
        <div class="field">
          <label class="label">Улица и дом</label>
          <input class="input" id="street" placeholder="Tartu mnt 10" autocomplete="address-line1">
        </div>
        <div class="row">
          <div class="field">
            <label class="label">Город</label>
            <input class="input" id="city" placeholder="Tallinn" autocomplete="address-level2">
          </div>
          <div class="field">
            <label class="label">Индекс</label>
            <input class="input" id="zip" placeholder="10145" autocomplete="postal-code">
          </div>
        </div>
        <div class="field">
          <label class="label">Страна</label>
          <input class="input" id="country" value="Estonia" disabled>
          <div class="hint">Доставляем по всей Эстонии</div>
        </div>

        <div id="quoteState" class="loading" style="display:none"></div>
        <div id="quoteOptions" class="options"></div>
        <div id="quoteWarnings" class="warn" style="display:none"></div>

        <div class="actions">
          <button class="btn btn-secondary" id="backToCart">Вернуться в корзину</button>
          <button class="btn btn-primary" id="payBtn" disabled>Оплатить</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 16px;">
      <h2 class="section-title">Итог</h2>
      <div class="summary-row"><span>Сумма товаров</span><span id="sumItems">0 €</span></div>
      <div class="summary-row"><span>Доставка</span><span id="sumShipping">—</span></div>
      <div class="summary-row total"><span>Итого к оплате</span><span id="sumTotal">0 €</span></div>
    </div>
  </div>

<script>
(function(){
  const el = (id) => document.getElementById(id);
  const itemsEl = el('items');
  const stateEl = el('quoteState');
  const optionsEl = el('quoteOptions');
  const warningsEl = el('quoteWarnings');
  const sumItemsEl = el('sumItems');
  const sumShippingEl = el('sumShipping');
  const sumTotalEl = el('sumTotal');
  const payBtn = el('payBtn');

  function getCart(){ return JSON.parse(localStorage.getItem('cart')||'[]'); }
  function saveCart(c){ localStorage.setItem('cart', JSON.stringify(c)); }

  function fmtEUR(x){ return new Intl.NumberFormat('ru-EE',{style:'currency',currency:'EUR'}).format(Number(x||0)); }

  function buildAddress(){
    const street = el('street').value.trim();
    const city   = el('city').value.trim();
    const zip    = el('zip').value.trim();
    const parts = [];
    if (street) parts.push(street);
    if (zip && city) parts.push(zip + ' ' + city);
    else if (city) parts.push(city);
    parts.push('Estonia');
    return parts.join(', ');
  }

  function subtotalEUR(cart){
    return cart.reduce((s,i)=> s + Number(i.price||0) * Number(i.qty||0), 0);
  }

  function renderItems(){
    const cart = getCart();
    itemsEl.innerHTML='';
    if (!cart.length){
      itemsEl.innerHTML = '<p class="muted">Корзина пуста</p>';
      updateSummary();
      return;
    }
    cart.forEach(item => {
      const wrap = document.createElement('div');
      wrap.className = 'item';
      wrap.innerHTML = `
        <img class="thumb" src="${item.img||''}" alt="${escapeHtml(item.name||'')}" onerror="this.style.display='none'">
        <div>
          <div class="name">${escapeHtml(item.name||'Товар')}</div>
          <div class="muted">Цена: ${fmtEUR(item.price)}</div>
          <div class="qty">
            <button class="qty-btn" data-act="-" data-id="${item.id}">-</button>
            <span>${item.qty}</span>
            <button class="qty-btn" data-act="+" data-id="${item.id}">+</button>
          </div>
        </div>
        <div class="line-total">${fmtEUR((item.price||0)*(item.qty||0))}</div>
      `;
      itemsEl.appendChild(wrap);
    });

    itemsEl.querySelectorAll('.qty-btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        const id = b.getAttribute('data-id');
        const act = b.getAttribute('data-act');
        const cart = getCart();
        const it = cart.find(x=> String(x.id)===String(id));
        if (!it) return;
        if (act === '+') it.qty = Math.min(99, Number(it.qty||0)+1);
        if (act === '-') it.qty = Math.max(0, Number(it.qty||0)-1);
        if (it.qty === 0) {
          const i = cart.findIndex(x=> String(x.id)===String(id));
          if (i>=0) cart.splice(i,1);
        }
        saveCart(cart);
        renderItems();
        triggerQuote();
      });
    });

    updateSummary();
  }

  function updateSummary(selected){
    const cart = getCart();
    const sub = subtotalEUR(cart);
    sumItemsEl.textContent = fmtEUR(sub);
    const ship = selected ? Number(selected.price_eur||0) : currentShippingPrice || 0;
    sumShippingEl.textContent = Number.isFinite(ship) ? fmtEUR(ship) : '—';
    const total = sub + (Number.isFinite(ship) ? ship : 0);
    sumTotalEl.textContent = fmtEUR(total);
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  // Debounce helper
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t = setTimeout(()=>fn(...a), ms); }; }

  let quoteInFlight = false;
  let lastQuote = null;
  let currentShippingPrice = null;
  let selectedOptionId = null;

  async function requestQuote(){
    const cart = getCart();
    if (!cart.length){
      stateEl.style.display = 'none';
      optionsEl.innerHTML = '';
      warningsEl.style.display = 'none';
      payBtn.disabled = true;
      updateSummary();
      return;
    }

    const address = buildAddress();
    if (!address || address.replace(/[,\s]/g,'').length < 3){
      stateEl.style.display = 'block';
      stateEl.className = 'loading';
      stateEl.textContent = 'Укажите адрес для расчёта доставки';
      optionsEl.innerHTML = '';
      warningsEl.style.display = 'none';
      payBtn.disabled = true;
      currentShippingPrice = null;
      updateSummary();
      return;
    }

    const subtotal = subtotalEUR(cart);

    quoteInFlight = true;
    payBtn.disabled = true;
    stateEl.style.display = 'block';
    stateEl.className = 'loading';
    stateEl.textContent = 'Считаем доставку…';
    warningsEl.style.display = 'none';

    try {
      const params = new URLSearchParams({
        address,
        subtotal: String(subtotal.toFixed(2)),
        items: JSON.stringify(cart.map(i=>({ id:i.id, qty:i.qty })))
      });
      const resp = await fetch(`/api/shipping-quote?${params.toString()}`, { headers: { Accept: 'application/json' } });
      const data = await resp.json();
      lastQuote = resp.ok ? data : null;
      if (!resp.ok){
        throw new Error(data && (data.message||data.error) || `Ошибка доставки ${resp.status}`);
      }
      renderOptions(data);
      stateEl.style.display = 'none';
      payBtn.disabled = false;
    } catch(err){
      optionsEl.innerHTML = '';
      stateEl.style.display = 'block';
      stateEl.className = 'error';
      stateEl.textContent = String(err.message||err);
      payBtn.disabled = true;
      currentShippingPrice = null;
      updateSummary();
    } finally {
      quoteInFlight = false;
    }
  }

  function renderOptions(quote){
    const opts = Array.isArray(quote.options) ? quote.options : [];
    if (!opts.length){
      optionsEl.innerHTML = '<div class="error">Нет доступных способов доставки</div>';
      currentShippingPrice = null;
      updateSummary();
      return;
    }

    // Try keep previous selection
    if (!selectedOptionId || !opts.find(o=>o.id===selectedOptionId)){
      // default to cheapest
      selectedOptionId = opts.slice().sort((a,b)=>Number(a.price_eur||0)-Number(b.price_eur||0))[0].id;
    }

    optionsEl.innerHTML = '';
    opts.forEach(o => {
      const row = document.createElement('label');
      row.className = 'option';
      row.innerHTML = `
        <input type="radio" name="ship" value="${o.id}" ${o.id===selectedOptionId?'checked':''}>
        <div>${escapeHtml(o.label||o.id)} <span class="muted">(~${o.eta_days||0} дн.)</span></div>
        <div class="price">${fmtEUR(o.price_eur)}</div>
      `;
      optionsEl.appendChild(row);
    });

    optionsEl.querySelectorAll('input[name="ship"]').forEach(r => {
      r.addEventListener('change', ()=>{
        selectedOptionId = r.value;
        const o = opts.find(x=>x.id===selectedOptionId);
        currentShippingPrice = o ? Number(o.price_eur||0) : null;
        updateSummary(o);
      });
    });

    const selected = opts.find(x=>x.id===selectedOptionId);
    currentShippingPrice = selected ? Number(selected.price_eur||0) : null;
    updateSummary(selected);

    // Warnings (e.g., missing weights)
    if (Array.isArray(quote.warnings) && quote.warnings.length){
      warningsEl.style.display = 'block';
      warningsEl.innerHTML = '<b>Примечания:</b> ' + quote.warnings.map(escapeHtml).join(', ');
    } else {
      warningsEl.style.display = 'none';
    }
  }

  const triggerQuote = debounce(requestQuote, 500);

  // Address listeners
  ['street','city','zip'].forEach(id => {
    el(id).addEventListener('input', triggerQuote);
  });

  // Back
  el('backToCart').addEventListener('click', ()=>{ window.location.href = '/cart'; });

  // Pay
  payBtn.addEventListener('click', async ()=>{
    const cart = getCart();
    if (!cart.length) return alert('Корзина пуста');
    if (quoteInFlight) return;
    if (!lastQuote) return alert('Сначала рассчитайте доставку');

    const address = buildAddress();
    if (!address || address.replace(/[,\s]/g,'').length < 3){
      return alert('Укажите адрес');
    }

    const selected = (lastQuote.options||[]).find(o=>o.id===selectedOptionId);
    if (!selected) return alert('Выберите способ доставки');

    payBtn.disabled = true;
    payBtn.textContent = 'Создание платежа…';

    try {
      const res = await fetch('/api/checkout', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({
          items: cart.map(i=>({ id:i.id, qty:i.qty })),
          shipping: {
            optionId: selected.id,
            address: address,
            price_eur: Number(selected.price_eur||0)
          }
        })
      });

      if (res.status === 409){
        const data = await res.json();
        // Обновим квоту из ответа сервера и попросим подтвердить
        if (data.quote){ lastQuote = data.quote; renderOptions(data.quote); }
        alert('Цена доставки изменилась. Проверьте новый тариф и подтвердите оплату.');
        return;
      }

      if (!res.ok){
        const txt = await res.text();
        throw new Error(txt || 'Ошибка при создании платежа');
      }

      const data = await res.json();
      if (data.url){ window.location.href = data.url; }
      else { throw new Error('Не получен URL Stripe Checkout'); }
    } catch(e){
      console.error(e);
      alert('Ошибка: ' + (e.message||e));
    } finally {
      payBtn.disabled = false;
      payBtn.textContent = 'Оплатить';
    }
  });

  // Init
  renderItems();
  triggerQuote();
})();
</script>
</body>
</html>
